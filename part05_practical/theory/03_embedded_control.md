# ğŸ”§ 03. çµ„ã¿è¾¼ã¿åˆ¶å¾¡ã¸ã®å±•é–‹ï¼ˆEmbedded Controlï¼‰

æœ¬ç¯€ã§ã¯ã€åˆ¶å¾¡ç†è«–ã‚’ **ãƒã‚¤ã‚³ãƒ³ãƒ»çµ„è¾¼ã¿ç’°å¢ƒï¼ˆC/Arduinoç­‰ï¼‰** ã¸å±•é–‹ã™ã‚‹ãŸã‚ã®è€ƒãˆæ–¹ã¨è¨­è¨ˆæ³•ã‚’è§£èª¬ã—ã¾ã™ã€‚  
é›¢æ•£æ™‚é–“åˆ¶å¾¡ãƒ»è¿‘ä¼¼ãƒ¢ãƒ‡ãƒ«ãƒ»å›ºå®šå°æ•°ç‚¹æ¼”ç®—ãªã©ã€å®Ÿè£…é¢ã®æ³¨æ„ç‚¹ã‚’æŠ¼ã•ãˆã¾ã™ã€‚

---

## ğŸ¯ å­¦ç¿’ç›®æ¨™

- é›¢æ•£åŒ–ã•ã‚ŒãŸåˆ¶å¾¡å‰‡ã‚’Cè¨€èªãƒ»Arduinoã§å®Ÿè£…ã§ãã‚‹  
- ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°å‘¨æœŸã¨ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡¦ç†ã®é–¢ä¿‚ã‚’ç†è§£ã™ã‚‹  
- PIDåˆ¶å¾¡ã®é›¢æ•£æ™‚é–“è¿‘ä¼¼ã‚’ç”¨ã„ãŸãƒ«ãƒ¼ãƒ—åˆ¶å¾¡ã‚’æ§‹æˆã§ãã‚‹  
- ã‚»ãƒ³ã‚µ/ã‚¢ã‚¯ãƒãƒ¥ã‚¨ãƒ¼ã‚¿ã¨ã®ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹åŸç†ã‚’ç†è§£ã™ã‚‹

---

## ğŸ§® é›¢æ•£PIDåˆ¶å¾¡ã®å®Ÿè£…å½¢å¼

### é›¢æ•£åŒ–ã®åŸºæœ¬å½¢ï¼ˆTustinæ³•ï¼‰

é€£ç¶šæ™‚é–“PIDåˆ¶å¾¡å™¨ï¼š

$$
u(t) = K_p e(t) + K_i \int e(t)dt + K_d \frac{de(t)}{dt}
$$

ã“ã‚Œã‚’**Tustinè¿‘ä¼¼**ã§é›¢æ•£åŒ–ã™ã‚‹ã¨ï¼š

```c
// C/Arduinoç”¨ã®é›¢æ•£PIDåˆ¶å¾¡ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
float e = ref - y;
integral += e * dt;
derivative = (e - prev_e) / dt;
u = Kp * e + Ki * integral + Kd * derivative;
prev_e = e;
```
	â€¢	refï¼šç›®æ¨™å€¤
	â€¢	yï¼šç¾åœ¨ã®å‡ºåŠ›
	â€¢	dtï¼šã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°å‘¨æœŸ
	â€¢	Kp, Ki, Kdï¼šå„ã‚²ã‚¤ãƒ³

---

## ğŸ”Œ å®Ÿè£…æ™‚ã®ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢æ§‹æˆï¼ˆä¾‹ï¼‰

ä»¥ä¸‹ã¯ã€Arduinoã‚„çµ„ã¿è¾¼ã¿ç’°å¢ƒã§PIDåˆ¶å¾¡ã‚’è¡Œã†éš›ã®ä¸€èˆ¬çš„ãªæ§‹æˆä¾‹ã§ã™ã€‚

| æ§‹æˆè¦ç´          | å½¹å‰²                          | å…·ä½“ä¾‹                        |
|------------------|-------------------------------|-------------------------------|
| Arduino UNO / STM32 | åˆ¶å¾¡æ¼”ç®—ã®å®Ÿè¡Œ                | PIDè¨ˆç®—ãƒ»PWMå‡ºåŠ›              |
| ãƒ¢ãƒ¼ã‚¿ï¼‹ãƒ‰ãƒ©ã‚¤ãƒ | ã‚¢ã‚¯ãƒãƒ¥ã‚¨ãƒ¼ã‚¿ï¼ˆå‹•åŠ›ï¼‰         | DCãƒ¢ãƒ¼ã‚¿ã€TB6612FNGãªã©       |
| ã‚»ãƒ³ã‚µé¡         | çŠ¶æ…‹è¦³æ¸¬ï¼ˆé€Ÿåº¦ãƒ»è§’åº¦ãªã©ï¼‰     | ãƒ›ãƒ¼ãƒ«ICã€ãƒ­ãƒ¼ã‚¿ãƒªã‚¨ãƒ³ã‚³ãƒ¼ãƒ€  |
| ã‚·ãƒªã‚¢ãƒ«é€šä¿¡     | PCã¨ã®é€£æºãƒ»ãƒ‡ãƒ¼ã‚¿å¯è¦–åŒ–       | `Serial.print()` ã‚„ Pythoné€£æº |

> ğŸ’¡ ã‚»ãƒ³ã‚µã‹ã‚‰ã®å…¥åŠ› â†’ åˆ¶å¾¡æ¼”ç®— â†’ ã‚¢ã‚¯ãƒãƒ¥ã‚¨ãƒ¼ã‚¿ã¸ã®å‡ºåŠ›ï¼ˆPWMï¼‰ã¨ã„ã†**åˆ¶å¾¡ãƒ«ãƒ¼ãƒ—**ã‚’å½¢æˆã—ã¾ã™ã€‚

---

## ğŸ“ ã‚¿ã‚¤ãƒŸãƒ³ã‚°è¨­è¨ˆã®æ³¨æ„ç‚¹

çµ„ã¿è¾¼ã¿ç’°å¢ƒã§ã¯ã€åˆ¶å¾¡ã®ã€Œæ™‚é–“ç²¾åº¦ã€ãŒå®‰å®šå‹•ä½œã®éµã«ãªã‚Šã¾ã™ã€‚

| é …ç›®              | æ¨å¥¨ / æ³¨æ„ç‚¹                          |
|-------------------|---------------------------------------|
| ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°å‘¨æœŸ  | é€šå¸¸ 10msã€œ100ms ç¨‹åº¦ï¼ˆ10Hzã€œ100Hzï¼‰ |
| å®Ÿè¡Œæ™‚é–“          | åˆ¶å¾¡è¨ˆç®—ï¼‹å‡ºåŠ›ãŒå‘¨æœŸå†…ã«åã¾ã‚‹å¿…è¦   |
| å‰²ã‚Šè¾¼ã¿åˆ¶å¾¡      | `TimerInterrupt` ã‚’ç”¨ã„ã‚‹ã¨å®‰å®š       |
| delay()ã®ä½¿ç”¨     | éæ¨å¥¨ï¼ˆã‚¿ã‚¤ãƒŸãƒ³ã‚°ç²¾åº¦ãŒè½ã¡ã‚‹ï¼‰       |
| å‘¨æ³¢æ•°é¸å®š        | åˆ¶å¾¡å¯¾è±¡ã®å¿œç­”é€Ÿåº¦ã«å¿œã˜ã¦æ±ºå®š       |

> âš ï¸ å¿œç­”ãŒé€Ÿã„ãƒ¢ãƒ¼ã‚¿ã§ã¯ **1kHzä»¥ä¸Šã®åˆ¶å¾¡å‘¨æœŸ** ãŒå¿…è¦ã«ãªã‚‹å ´åˆã‚‚ã‚ã‚Šã¾ã™ã€‚

---

## ğŸ’¡ Tipsï¼šå›ºå®šå°æ•°ç‚¹æ¼”ç®—ã¨ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°

Arduino UNO ã®ã‚ˆã†ãª8bitãƒã‚¤ã‚³ãƒ³ã§ã¯æµ®å‹•å°æ•°ç‚¹æ¼”ç®—ï¼ˆfloatï¼‰ãŒ**é…ã„ï¼é‡ã„**ãŸã‚ã€  
å®Ÿè£…ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«**å›ºå®šå°æ•°ç‚¹æ¼”ç®—ï¼ˆintå‹ï¼‹ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ï¼‰**ãŒæ¨å¥¨ã•ã‚Œã¾ã™ã€‚

### ä¾‹ï¼šå›ºå®šå°æ•°ç‚¹è¿‘ä¼¼ï¼ˆCã‚³ãƒ¼ãƒ‰ï¼‰

```c
// 16bitæ•´æ•°ã§PIDï¼ˆKp = 32, scale = 5 â†’ å®ŸåŠ¹Kp=1.0ï¼‰
int16_t e = ref - y;
int32_t p_term = (int32_t)(Kp * e) >> scale;
```

	â€¢	Kp = 32ã€scale = 5 â‡’ å®ŸåŠ¹ã‚²ã‚¤ãƒ³ = 32 / 2âµ = 1.0
	â€¢	>> scale ã¯ã€Œé™¤ç®—ã‚ˆã‚Šé«˜é€Ÿãªãƒ“ãƒƒãƒˆã‚·ãƒ•ãƒˆæ¼”ç®—ã€

---

## ğŸ› ï¸ Arduino/STM32ã¸ã®å®Ÿè£…ä¾‹ï¼ˆåˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã§æä¾›ï¼‰

æœ¬æ•™æã§ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãª**çµ„ã¿è¾¼ã¿åˆ¶å¾¡å®Ÿé¨“ç”¨ã‚³ãƒ¼ãƒ‰ãƒ»ãƒ„ãƒ¼ãƒ«**ã‚’åˆ¥é€”æä¾›ã—ã¾ã™ã€‚

| ãƒ•ã‚¡ã‚¤ãƒ«å                   | å†…å®¹                                   |
|------------------------------|----------------------------------------|
| `pid_embedded.ino`           | Arduinoã«ã‚ˆã‚‹é›¢æ•£PIDåˆ¶å¾¡ãƒ«ãƒ¼ãƒ—ã®å®Ÿè£…   |
| `sensor_plotter.py`          | Pythonå´ã§ã‚»ãƒ³ã‚µãƒ‡ãƒ¼ã‚¿ã‚’ãƒ—ãƒ­ãƒƒãƒˆè¡¨ç¤º   |
| `arduino_serial_logger.py`   | ã‚·ãƒªã‚¢ãƒ«é€šä¿¡ãƒ­ã‚°åé›†ç”¨ã®è£œåŠ©ãƒ„ãƒ¼ãƒ«     |

> ğŸ”§ `pid_embedded.ino` ã¯ã€DCãƒ¢ãƒ¼ã‚¿åˆ¶å¾¡ã‚„æ¸©åº¦åˆ¶å¾¡ãªã©ã«ãã®ã¾ã¾é©ç”¨å¯èƒ½ã§ã™ã€‚  
> ãƒ‡ãƒãƒƒã‚°ã‚„å¯è¦–åŒ–ã®ãŸã‚ã«ã€**Pythonã¨ã®é€£æº**ãŒåŠ¹æœçš„ã§ã™ã€‚

---

### ğŸ“¡ ã‚·ãƒªã‚¢ãƒ«é€šä¿¡ã«ã‚ˆã‚‹PCé€£æºä¾‹ï¼ˆã‚»ãƒ³ã‚µãƒ—ãƒ­ãƒƒãƒˆï¼‰

```python
# sensor_plotter.py ã®åŸºæœ¬æ§‹æˆä¾‹
import serial
import matplotlib.pyplot as plt

ser = serial.Serial('COM3', 9600)
data = []

for _ in range(200):
    line = ser.readline().decode().strip()
    data.append(float(line))

plt.plot(data)
plt.title("Sensor Output from Arduino")
plt.grid()
plt.show()
```

---

## ğŸ“˜ åˆ¶å¾¡å¯¾è±¡ä¾‹ï¼ˆå¿œç”¨ï¼‰

çµ„ã¿è¾¼ã¿åˆ¶å¾¡æŠ€è¡“ã¯ã€å¤šç¨®å¤šæ§˜ãªå¯¾è±¡ã«å¿œç”¨å¯èƒ½ã§ã™ã€‚  
ä»¥ä¸‹ã¯ã€æ•™è‚²ãƒ»å®Ÿé¨“ãƒ»ç”£æ¥­ç”¨ã«ãŠã„ã¦ã‚ˆãåˆ©ç”¨ã•ã‚Œã‚‹ä¾‹ã§ã™ã€‚

| åˆ¶å¾¡å¯¾è±¡           | å†…å®¹ãƒ»ç‰¹å¾´                             | å‚™è€ƒ |
|--------------------|----------------------------------------|------|
| DCãƒ¢ãƒ¼ã‚¿é€Ÿåº¦åˆ¶å¾¡   | ã‚¨ãƒ³ã‚³ãƒ¼ãƒ€ã§å›è»¢é€Ÿåº¦ã‚’è¨ˆæ¸¬ã—ã€PWMåˆ¶å¾¡ | å›è»¢æ•°ã®å®‰å®šåŒ–ãƒ»è¿½å¾“åˆ¶å¾¡ã«ä½¿ç”¨ |
| æ¸©åº¦åˆ¶å¾¡           | ã‚µãƒ¼ãƒŸã‚¹ã‚¿ï¼‹ãƒ’ãƒ¼ã‚¿ãƒ¼åˆ¶å¾¡              | ã‚¤ãƒ³ã‚­ãƒ¥ãƒ™ãƒ¼ã‚¿ãƒ»æ’æ¸©æ§½ãªã© |
| é›»æµåˆ¶å¾¡           | ã‚·ãƒ£ãƒ³ãƒˆæŠµæŠ—ï¼‹ã‚¹ã‚¤ãƒƒãƒãƒ³ã‚°åˆ¶å¾¡        | é›»æºãƒ»ãƒãƒƒãƒ†ãƒªå……é›»ç³»ç­‰ |
| 2è¼ªè‡ªå¾‹ç§»å‹•ä½“      | å·¦å³ãƒ¢ãƒ¼ã‚¿ã‚’å€‹åˆ¥åˆ¶å¾¡ã€å§¿å‹¢å®‰å®šåŒ–      | å€’ç«‹æŒ¯å­ãƒ»ãƒ©ã‚¤ãƒ³ãƒˆãƒ¬ãƒ¼ã‚¹ |
| LEDè¼åº¦åˆ¶å¾¡        | ç…§åº¦ã‚»ãƒ³ã‚µã¨ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯åˆ¶å¾¡        | ç’°å¢ƒé©å¿œå‹ç…§æ˜ã«å¿œç”¨å¯ |

> å®Ÿé¨“ã‚­ãƒƒãƒˆã¨ã—ã¦ã¯ã€ã‚¹ã‚¤ãƒƒãƒã‚µã‚¤ã‚¨ãƒ³ã‚¹ã‚„ç§‹æœˆé›»å­ãªã©ã®DCãƒ¢ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã€æ¸©åº¦åˆ¶å¾¡ã‚­ãƒƒãƒˆãŒåˆ©ç”¨ã§ãã¾ã™ã€‚

---

## ğŸ“š å‚è€ƒè³‡æ–™

- [Arduino PIDå®Ÿé¨“ï¼šBrett Beauregard](https://brettbeauregard.com/blog/2011/04/improving-the-beginners-pid-introduction/)
- [ROS + STM32é€£æºãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«](https://wiki.ros.org/rosserial_arduino)
- [çµ„è¾¼ã¿åˆ¶å¾¡é–‹ç™ºã®ãŸã‚ã®æ•™ç§‘æ›¸]ï¼šä¸¸å–„ã€CQå‡ºç‰ˆãªã©
- æœ¬æ•™æã®é–¢é€£ç« ï¼š
  - `part04_digital/`ï¼šé›¢æ•£åˆ¶å¾¡ã®ç†è«–
  - `part05_practical/simulation/`ï¼šåˆ¶å¾¡æ¼”ç¿’ã‚³ãƒ¼ãƒ‰
  - `part06_ai/`ï¼šAIåˆ¶å¾¡ã¨ã®é€£æºï¼ˆæ¬¡ä¸–ä»£å±•é–‹ï¼‰

---





