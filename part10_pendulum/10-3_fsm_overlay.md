---
title: "10-3 FSMオーバレイ制御：効いた点と効かなかった点"
emoji: "🧭"
type: "tech"
topics: ["制御", "倒立振子", "FSM", "PID"]
published: false
---

# 10-3 FSMオーバレイ制御  
## 効いた点と効かなかった点

本章では、**PID制御の上にFSM（Finite State Machine）を被せる**。  
目的は「賢くする」ことではない。

> **PIDに判断をさせないために、判断だけを切り出す**

それだけである。

---

## 1. なぜFSMが必要か（再確認）

前章で示した通り、PIDは以下を判断できない。

- 今は小振幅か？
- すでに大振幅か？
- 入力が飽和しているか？
- 回復不能か？

そこで構造を分ける：

- **PID**：連続量制御（角度・速度）
- **FSM**：状態判定とモード切替

---

## 2. FSMの状態定義（最小構成）

今回は **最低限の3状態** に限定する。

### 状態集合

$$
\mathcal{S} = \{ S_1, S_2, S_3 \}
$$

| 状態 | 意味 |
|---|---|
| $$S_1$$ | Swing-up（振り上げ） |
| $$S_2$$ | Balance（直立保持） |
| $$S_3$$ | Fail-safe（脱出） |

---

## 3. 状態遷移条件

### 3.1 角度しきい値

$$
|\theta| < \theta_{\text{bal}}
\quad \Rightarrow \quad S_2
$$

$$
|\theta| \ge \theta_{\text{bal}}
\quad \Rightarrow \quad S_1
$$

### 3.2 回復不能条件

$$
|\theta| > \theta_{\text{fail}}
\quad \Rightarrow \quad S_3
$$

ここで：

$$
0 < \theta_{\text{bal}} < \theta_{\text{fail}} < \pi
$$

---

## 4. 各状態での制御則

### 4.1 Swing-up（ $$S_1$$ ）

単純なエネルギー制御（例）：

$$
u =
K_e \left(
E_{\text{ref}} - E(\theta,\dot{\theta})
\right)\operatorname{sgn}(\dot{\theta}\cos\theta)
$$

※ 詳細は本教材の範囲外。  
**重要なのは「PIDを使わない」こと。**

---

### 4.2 Balance（ $$S_2$$ ）

前章と同じ PID：

$$
u =
K_p (-\theta) + K_d (-\dot{\theta}) + K_i \int (-\theta)\,dt
$$

FSMは **ゲインを変えない**。  
「使うか／使わないか」だけを決める。

---

### 4.3 Fail-safe（$$S_3$$）

$$
u = 0
$$

あるいは：

$$
u = -K_x \dot{x}
$$

→ **倒れるのを前提に安全に逃がす**

---

## 5. FSMを入れて「何が改善したか」

### 改善①：適用範囲の明確化

PIDが使われるのは：

$$
|\theta| < \theta_{\text{bal}}
$$

のみ。

→ **設計条件が守られる**

---

### 改善②：飽和破綻の回避

Swing-up中は：

- 大入力OK
- 飽和前提

Balanceでは：

- 小入力
- 線形前提

→ **役割分離が成立**

---

### 改善③：失敗を定義できる

FSMを入れることで：

> **「これは失敗です」**

をシステム自身が宣言できる。

PID単体では不可能。

---

## 6. それでも効かなかった点（重要）

ここを隠さない。

---

### 6.1 状態境界のチャタリング

$$
|\theta| \approx \theta_{\text{bal}}
$$

付近で：

$$
S_1 \leftrightarrow S_2
$$

が高速切替。

→ 入力がギザギザ  
→ 実機では危険

---

### 6.2 ノイズに弱い

判定条件が：

$$
\theta,\ \dot{\theta}
$$

のみの場合：

- センサノイズ
- 推定誤差

で **誤遷移** が起きる。

FSMは **離散的に壊れる**。

---

### 6.3 本質的な性能は上がらない

FSMは：

- 安定性を「作らない」
- 最適性を「改善しない」

あくまで：

> **使い分けの整理役**

---

## 7. 本章の結論（重要）

FSMは：

- ✅ PIDの限界を隠さない
- ✅ 動作条件を明文化する
- ❌ 魔法ではない

> **FSMは「制御」ではなく「構造」**

---

## 8. EduController への接続

この構造は、そのまま：

- 内側：PID（連続）
- 中間：FSM（判断）
- 外側：再設計・再同定（将来）

という **三層構造** に対応する。

---

## チェックリスト

- [ ] FSMの役割を限定した
- [ ] 効いた点／効かなかった点を分けた
- [ ] PIDを過大評価しなかった
- [ ] 次の層への接続を残した
